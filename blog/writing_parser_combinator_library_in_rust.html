
<!DOCTYPE html>
<html>
<head>
    <title>nireo</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <div class="links">
                <a href="/">home</a>
                <a href="/projects">projects</a>
                <a href="/links">links</a>
                <a href="https://github.com/nireo" rel="noopener noreferrer" target="_blank">github</a>
            </div>
        </nav>
        
        <div class="content">
            <main>
                <h1 id="writing-a-parser-combinator-library-in-rust">writing a parser combinator library in rust</h1>
<p>Recently for a compilers course we had to write a small parser combinators library using gleam and afterwards use the <code>nom</code> library in Rust for parsing a lisp-like syntax. These we're really fun exercises and I found that <code>nom</code> was very complicated so I wanted to see how one would write a simpler version also in Rust.</p>
<p>The idea is that a parser combinator is simply just a higher-order function which takes in however many other parsers and in turn return a new parser. With this parser we can provide some kind of input and then returns a given output which can be specified. This is really vague so let's first define some very basic types:</p>
<pre><code>pub type Input&lt;'a&gt; = &amp;'a str;
pub type ParseResult&lt;'a, T&gt; = Result&lt;(Input&lt;'a&gt;, T), &amp;'static str&gt;;
</code></pre>
<p>Here we define the two most basic parts of our library. We are working with references to strings, this is done because we don't want to copy the string we are parsing and it makes ownership easier as we don't need to pass around a <code>String</code>. The <code>ParseResult</code> defines what a parser should ultimately return a result signaling if the parsing was successful. In case of a successful parse, we get a tuple with the rest of the input (with the part that the parser has parsed being removed) and some generic return value. In case, of an error we can just return a static error message for simplicity.</p>
<p>Now let's think about what the combinators themselves would look like. So we need to a function that takes in an function or functions and returns a new function. Let's start with one of the most simple parsers, <code>or</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">or</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, P, O<span style="color:#f92672">&gt;</span>(p1: <span style="color:#a6e22e">P</span>, p2: <span style="color:#a6e22e">P</span>) -&gt; <span style="color:#a6e22e">impl</span> Fn(Input<span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">ParseResult</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, O<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    P: Fn(Input<span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">ParseResult</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, O<span style="color:#f92672">&gt;</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">move</span> <span style="color:#f92672">|</span>input: <span style="color:#a6e22e">Input</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;|</span> <span style="color:#66d9ef">match</span> p1(input) {
</span></span><span style="display:flex;"><span>        Ok((rest, res)) <span style="color:#f92672">=&gt;</span> Ok((rest, res)),
</span></span><span style="display:flex;"><span>        Err(_) <span style="color:#f92672">=&gt;</span> p2(input),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Okay, there is a lot to unpack here. First, we define a function that takes in two different parsers. Here a parser is just a function that takes in an <code>Input</code> and returns a <code>ParseResult</code>. The return type of our <code>or</code> function is also a function that takes in an <code>Input</code> and returns a <code>ParseResult</code>. This is done using the <code>impl Fn(...) -&gt; ...</code> syntax which allows us to return closures.</p>
<p>Let's then write <code>and</code>, this should be pretty trivial given that we have <code>or</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">and</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, P1, P2, O1, O2<span style="color:#f92672">&gt;</span>(p1: <span style="color:#a6e22e">P1</span>, p2: <span style="color:#a6e22e">P2</span>) -&gt; <span style="color:#a6e22e">impl</span> Fn(Input<span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">ParseResult</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, (O1, O2)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    P1: Fn(Input<span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">ParseResult</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, O1<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    P2: Fn(Input<span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">ParseResult</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, O2<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">move</span> <span style="color:#f92672">|</span>input: <span style="color:#a6e22e">Input</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;|</span> <span style="color:#66d9ef">match</span> p1(input) {
</span></span><span style="display:flex;"><span>        Ok((rest, res1)) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> p2(rest) {
</span></span><span style="display:flex;"><span>            Ok((rest2, res2)) <span style="color:#f92672">=&gt;</span> Ok((rest2, (res1, res2))),
</span></span><span style="display:flex;"><span>            Err(e) <span style="color:#f92672">=&gt;</span> Err(e),
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        Err(e) <span style="color:#f92672">=&gt;</span> Err(e),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Now we know how to combine two parsers and perform some logic based on them. So let's look at some basic parsers that parse something many times, like <code>many</code>:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">many</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, P, O<span style="color:#f92672">&gt;</span>(p: <span style="color:#a6e22e">P</span>) -&gt; <span style="color:#a6e22e">impl</span> Fn(Input<span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">ParseResult</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, Vec<span style="color:#f92672">&lt;</span>O<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    P: Fn(Input<span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">ParseResult</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span>, O<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">move</span> <span style="color:#f92672">|</span><span style="color:#66d9ef">mut</span> input: <span style="color:#a6e22e">Input</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;|</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> results <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">let</span> Ok((rest, res)) <span style="color:#f92672">=</span> p(input) {
</span></span><span style="display:flex;"><span>            results.push(res);
</span></span><span style="display:flex;"><span>            input <span style="color:#f92672">=</span> rest;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok((input, results))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
                
            </main>
        </div>
    </div>
</body>
</html>
